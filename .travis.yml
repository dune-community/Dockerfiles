sudo: required
dist: trusty
language: generic
services: docker

# auto-updates docker engine
addons:
  apt:
    packages:
      - docker-ce

script:
  - cd ${TRAVIS_BUILD_DIR}
  - travis_wait 45 make ${SUBDIR}
  - |
    if [[ "${TRAVIS_PULL_REQUEST}" == "false" ]] && [[ "${TRAVIS_BRANCH}" == "master" ]] ; then
        docker login --username=$DOCKER_HUB_USERNAME --password=$DOCKER_HUB_PASSWORD
        make push_${SUBDIR}
    fi

notifications:
  email:
    on_success: change
    on_failure: change

stages:
  - 'Dev Images'
  - 'Testing Images'

env:
  global:
    - DOCKER_QUIET=-q
    - DOCKER_PRUNE=1
jobs:
  include:
    - stage: 'Dev Images'
      env: SUBDIR=debian_travis
    - stage: 'Dev Images'
      env: SUBDIR=debian_unstable_travis
    - stage: 'Dev Images'
      env: SUBDIR=manylinux
    - stage: 'Testing Images'
      env: SUBDIR=testing

matrix:
  allow_failures:
  # see https://github.com/dune-community/Dockerfiles/issues/21
    - env: SUBDIR=arch
